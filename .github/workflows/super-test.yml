name: Run E2E Tests on Merge
on:
  push:
    branches:
      - master
jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
            node-version: '18'
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
        # 注意：如果你的 Playwright 是通过 Java 调用的，仍需此步骤来安装浏览器二进制文件

      - name: Configure Maven settings for reliable download
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
          <settings>
            <mirrors>
              <mirror>
                <id>central-mirror</id>
                <url>https://repo1.maven.org/maven2</url>
                <mirrorOf>central</mirrorOf>
              </mirror>
            </mirrors>
          </settings>
          EOF
      - name: Debug:Show test source files
        run: |
          echo "=== Source test files ==="
          find src/test -name "*.java" | sort

      - name: Debug:Compile tests explicitly
        run: mvn clean test-compile -q

      - name: Debug:Show compiled test classes
        run: |
          echo "=== Compiled test classes ==="
          find target/test-classes -type f | grep -i normal || echo "No compiled classes found for 'normal'!"

      - name: Debug:Check if TestNG is in test classpath
        run: |
          echo "=== TestNG in classpath? ==="
          mvn dependency:build-classpath -DincludeScope=test -q | tr ':' '\n' | grep -i testng || echo "TestNG not found!"

      - name: Run specific TestNG test package
        run: mvn -U --batch-mode clean test -Dtest="org.test.normal.*"
        # 上面会运行 com.example.e2e.tests 包下所有 TestNG 测试类

      - name: Upload Test Results (Optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: target/surefire-reports/